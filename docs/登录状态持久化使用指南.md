# Playwright 登录状态持久化使用指南

## 功能概述

Playwright 登录状态持久化功能允许您保存一次登录状态后，后续的所有测试用例都可以复用这个登录状态，无需每次都重新登录。

### 优点

- ⚡ **节省时间**：避免每个测试用例都执行登录操作
- 🎯 **提高效率**：测试用例可以直接从登录后的状态开始
- 🔒 **真实模拟**：保持真实的浏览器会话状态
- 💾 **自动加载**：系统会自动检测并加载保存的登录状态

## 使用方法

### 方法一：使用命令行工具（推荐）

1. **打开命令行**，进入项目后端目录：
   ```bash
   cd c:\AI\testserver\backend
   ```

2. **运行保存工具**：
   ```bash
   python save_auth_state.py --project-id <项目ID> --url <登录页面URL>
   ```

   例如：
   ```bash
   python save_auth_state.py --project-id 1 --url https://fanyi.baidu.com
   ```

3. **在浏览器中登录**：
   - 工具会自动打开浏览器
   - 在浏览器中手动完成登录操作
   - 登录成功后，在命令行按 Enter 键

4. **完成保存**：
   - 系统会自动保存认证状态
   - 显示保存的 Cookies 数量和域名数量

### 方法二：通过测试用例保存（开发中）

未来版本会在前端界面提供"保存当前登录状态"按钮。

## 工作原理

### 认证状态包含什么？

保存的认证状态包括：
- **Cookies**：浏览器 Cookies
- **LocalStorage**：本地存储数据
- **SessionStorage**：会话存储数据
- **IndexedDB**：索引数据库

### 文件存储位置

认证状态文件存储在：
```
backend/auth_states/project_{项目ID}_auth.json
```

例如：
```
backend/auth_states/project_1_auth.json
backend/auth_states/project_2_auth.json
```

### 自动加载机制

执行测试用例时，系统会：
1. 检查项目是否有保存的认证状态文件
2. 如果存在，自动加载到浏览器上下文
3. 测试脚本可以直接从登录后的状态开始

## 使用示例

### 示例 1：百度翻译登录

```bash
# 1. 保存登录状态
python save_auth_state.py --project-id 1 --url https://fanyi.baidu.com

# 2. 在浏览器中登录（手动操作）
#    - 输入用户名和密码
#    - 点击登录

# 3. 登录成功后，按 Enter 键

# 输出示例：
# ✅ 认证状态已保存（包含 5 个 cookies）
# 📁 文件路径: backend/auth_states/project_1_auth.json
# 🍪 Cookies 数量: 5
# 🌐 域名数量: 2
```

### 示例 2：测试用例编写

保存登录状态后，测试用例脚本可以跳过登录步骤：

**之前（每次都要登录）：**
```json
{
  "browser": "chromium",
  "viewport": {"width": 1280, "height": 720},
  "steps": [
    {
      "index": 1,
      "action": "goto",
      "value": "https://fanyi.baidu.com",
      "description": "打开百度翻译"
    },
    {
      "index": 2,
      "action": "click",
      "selector": "#login-btn",
      "description": "点击登录按钮"
    },
    {
      "index": 3,
      "action": "fill",
      "selector": "#username",
      "value": "your_username",
      "description": "输入用户名"
    },
    {
      "index": 4,
      "action": "fill",
      "selector": "#password",
      "value": "your_password",
      "description": "输入密码"
    },
    {
      "index": 5,
      "action": "click",
      "selector": "#submit",
      "description": "点击登录"
    },
    {
      "index": 6,
      "action": "click",
      "selector": "#pro-translation",
      "description": "点击专业翻译"
    }
  ]
}
```

**之后（直接从登录后开始）：**
```json
{
  "browser": "chromium",
  "viewport": {"width": 1280, "height": 720},
  "steps": [
    {
      "index": 1,
      "action": "goto",
      "value": "https://fanyi.baidu.com",
      "description": "打开百度翻译（已登录）"
    },
    {
      "index": 2,
      "action": "click",
      "selector": "#pro-translation",
      "description": "点击专业翻译"
    }
  ]
}
```

## 管理认证状态

### 查看认证状态

通过 API 查看项目的认证状态信息：

```bash
GET /api/projects/{project_id}/auth-state
```

响应示例：
```json
{
  "exists": true,
  "file_path": "backend/auth_states/project_1_auth.json",
  "cookies_count": 5,
  "origins_count": 2,
  "file_size": 1234,
  "modified_time": 1704067200.0
}
```

### 删除认证状态

如果需要重新登录，可以删除认证状态：

```bash
DELETE /api/projects/{project_id}/auth-state
```

或者手动删除文件：
```bash
rm backend/auth_states/project_{project_id}_auth.json
```

## 常见问题

### Q: 什么时候需要重新保存登录状态？

A: 以下情况需要重新保存：
- 修改了登录密码
- 登录状态已过期（通常是会话超时）
- 网站更新了认证机制
- 跨域或多子域名认证

### Q: 登录状态会过期吗？

A: 会的。登录状态的有效期取决于网站的会话策略。一般情况下：
- 短期会话：几小时到几天
- 长期会话：几周到几个月（"记住我"选项）

如果发现测试失败提示"未登录"，需要重新保存登录状态。

### Q: 多个项目可以共享登录状态吗？

A: 不可以。每个项目有独立的认证状态文件，互不影响。这样设计是为了：
- 支持测试不同的账号
- 支持测试不同的网站
- 避免状态冲突

### Q: 如何测试不同的用户角色？

A: 如果需要测试不同的用户角色（如管理员、普通用户），建议：
1. 创建多个项目，每个项目对应一个用户角色
2. 分别为每个项目保存对应的登录状态

### Q: 保存的认证状态安全吗？

A: 认证状态文件包含敏感信息（Cookies、Tokens），建议：
- ✅ 将 `auth_states/` 目录添加到 `.gitignore`
- ✅ 不要提交认证状态文件到版本控制
- ✅ 定期清理过期的认证状态

## 技术细节

### 认证状态文件格式

认证状态文件是标准的 JSON 格式：

```json
{
  "cookies": [
    {
      "name": "session_id",
      "value": "xxxxx",
      "domain": ".example.com",
      "path": "/",
      "expires": 1704067200,
      "httpOnly": true,
      "secure": true,
      "sameSite": "Lax"
    }
  ],
  "origins": [
    {
      "origin": "https://example.com",
      "localStorage": [
        {
          "name": "user_id",
          "value": "12345"
        }
      ]
    }
  ]
}
```

### Playwright API

系统使用 Playwright 的 `storage_state` API：

**保存：**
```python
context.storage_state(path="auth.json")
```

**加载：**
```python
context = browser.new_context(storage_state="auth.json")
```

## 最佳实践

### 1. 登录步骤独立化

建议创建一个专门的"登录测试用例"，只负责登录并保存状态。

### 2. 定期验证

定期执行一个简单的测试用例，验证登录状态是否有效。

### 3. 优雅降级

测试脚本应该支持两种模式：
- 有登录状态：直接使用
- 无登录状态：自动登录

### 4. 错误处理

如果测试因"未登录"失败：
1. 检查认证状态文件是否存在
2. 检查是否已过期
3. 重新保存登录状态

## 示例脚本

### 完整的登录状态保存流程

```bash
# 1. 检查现有状态
curl http://localhost:8000/api/projects/1/auth-state

# 2. 保存新的登录状态
python save_auth_state.py --project-id 1 --url https://fanyi.baidu.com

# 3. 验证保存成功
curl http://localhost:8000/api/projects/1/auth-state

# 4. 执行测试用例
curl -X POST http://localhost:8000/api/cases/1/execute

# 5. 查看测试结果
curl http://localhost:8000/api/runs/{run_id}
```

## 总结

Playwright 登录状态持久化是一个强大的功能，可以显著提升测试效率。只需保存一次登录状态，后续所有测试用例都可以复用，极大节省了测试时间。

**关键点：**
- ✅ 使用 `save_auth_state.py` 工具保存登录状态
- ✅ 系统会自动检测并加载保存的状态
- ✅ 测试脚本可以跳过登录步骤
- ✅ 定期验证和更新登录状态
