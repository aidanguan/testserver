# 测试用例编辑功能使用说明

## 功能概述

编辑测试用例功能允许用户修改已创建的测试用例，包括：
- 基本信息（名称、描述、预期结果）
- 测试步骤
- 测试脚本（Playwright 或 Midscene）

## 使用步骤

### 1. 打开编辑弹窗

在项目详情页的测试用例列表中，点击任意测试用例的"编辑"按钮。

### 2. 三步骤编辑流程

#### 步骤 1：编辑描述

编辑测试用例的基本信息：
- **用例名称**：测试用例的名称（必填）
- **用例描述**：详细描述测试用例的目的和场景
- **预期结果**：测试成功时的预期结果

点击"下一步"继续。

#### 步骤 2：编辑步骤

编辑测试用例的标准化步骤：
- 点击"添加步骤"按钮添加新的测试步骤
- 每个步骤包含：
  - **操作类型**：导航、点击、输入、等待、验证
  - **目标元素**：CSS 选择器或自然语言描述
  - **操作值**：输入的值或参数
  - **描述**：步骤的详细说明
- 点击"删除"按钮删除不需要的步骤（至少保留一个步骤）

点击"下一步"继续。

#### 步骤 3：编辑脚本

根据测试用例的执行器类型，编辑对应的脚本：

##### Midscene 脚本（JSON 格式）

如果测试用例使用 Midscene 执行器，您将看到 JSON 格式的编辑器。

**示例脚本：**
```json
{
  "base_url": "https://example.com",
  "steps": [
    {
      "action": "navigate",
      "target": "登录页面",
      "description": "打开登录页面"
    },
    {
      "action": "input",
      "target": "用户名输入框",
      "value": "admin",
      "description": "输入用户名"
    },
    {
      "action": "input",
      "target": "密码输入框",
      "value": "password123",
      "description": "输入密码"
    },
    {
      "action": "click",
      "target": "登录按钮",
      "description": "点击登录按钮"
    }
  ]
}
```

**注意事项：**
- 必须是有效的 JSON 格式
- `target` 字段使用自然语言描述元素（Midscene 会使用 AI 定位）
- 支持的 action 类型：navigate、click、input、wait、assert

##### Playwright 脚本（Python 格式）

如果测试用例使用 Playwright 执行器，您将看到 Python 代码编辑器。

**示例脚本：**
```json
{
  "base_url": "https://example.com",
  "steps": [
    {
      "index": 1,
      "action": "navigate",
      "selector": "/login",
      "description": "导航到登录页面"
    },
    {
      "index": 2,
      "action": "input",
      "selector": "#username",
      "value": "admin",
      "description": "输入用户名"
    },
    {
      "index": 3,
      "action": "input",
      "selector": "#password",
      "value": "password123",
      "description": "输入密码"
    },
    {
      "index": 4,
      "action": "click",
      "selector": "button[type='submit']",
      "description": "点击登录按钮"
    }
  ]
}
```

**注意事项：**
- `selector` 字段使用 CSS 选择器
- 每个步骤必须有 `index` 字段
- 支持的 action 类型：navigate、click、input、wait、assert、screenshot

### 3. 保存修改

在步骤 3 完成脚本编辑后，点击"保存"按钮提交修改。

系统会验证：
- Midscene 脚本的 JSON 格式是否正确
- Playwright 脚本的 JSON 格式是否正确

验证通过后，修改将被保存，并自动刷新测试用例列表。

## 常见问题

### Q: 修改脚本后，原来的执行记录会丢失吗？

A: 不会。历史执行记录会保留，但新的执行将使用修改后的脚本。

### Q: 可以在编辑时切换执行器类型吗？

A: 目前不支持。如果需要切换执行器类型，建议创建新的测试用例。

### Q: Midscene 脚本中的自然语言描述有什么要求？

A: 描述应该清晰、具体，便于 AI 理解和定位元素。例如：
- ✅ 好的描述："用户名输入框"、"红色的提交按钮"、"顶部导航菜单中的'设置'链接"
- ❌ 不好的描述："输入框"、"按钮"、"链接"（太模糊）

### Q: 为什么我的 Midscene 脚本执行失败？

A: 可能的原因：
1. 元素描述太模糊，AI 无法准确定位
2. 页面结构与描述不匹配
3. 页面加载速度慢，需要添加等待步骤
4. LLM 配置不正确（检查项目设置中的 API Key 和 Base URL）

建议：
- 使用更具体的元素描述
- 添加适当的等待步骤
- 查看执行日志中的错误信息
- 检查 LLM 配置是否正确

## 技术细节

### 数据结构

#### 标准化步骤（standard_steps）

```json
[
  {
    "index": 1,
    "action": "navigate",
    "selector": "/path",
    "value": "",
    "description": "步骤描述"
  }
]
```

#### Midscene 脚本（midscene_script）

```json
{
  "base_url": "https://example.com",
  "steps": [
    {
      "action": "action_type",
      "target": "元素的自然语言描述",
      "value": "输入值（可选）",
      "description": "步骤描述"
    }
  ]
}
```

#### Playwright 脚本（playwright_script）

```json
{
  "base_url": "https://example.com",
  "steps": [
    {
      "index": 1,
      "action": "action_type",
      "selector": "CSS选择器",
      "value": "输入值（可选）",
      "description": "步骤描述"
    }
  ]
}
```

### API 端点

- **PUT** `/cases/{case_id}` - 更新测试用例
  - 请求体：`TestCaseUpdate` schema
  - 响应：`TestCaseResponse` schema

### 数据验证

后端会验证：
1. Midscene 脚本是否为有效的 JSON 格式
2. Playwright 脚本是否为有效的 JSON 格式
3. 必填字段是否完整
4. 数据类型是否正确
