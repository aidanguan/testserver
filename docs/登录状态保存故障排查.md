# 登录状态保存故障排查指南

## 常见错误及解决方案

### 错误 0：线程错误 - cannot switch to a different thread

**错误信息：**
```
保存失败: 保存认证状态失败: cannot switch to a different thread (which happens to have exited)
```

**原因：**
Playwright 在后台线程中启动浏览器，但在主线程中调用 `context.storage_state()` 时产生跨线程操作错误。Playwright 的对象必须在同一个线程中使用。

**解决方案：**
已在代码中修复，使用线程同步机制：
- 使用 `queue.Queue` 跨线程传递结果
- 在新线程中执行 `save_auth_state()` 和 `browser.close()`
- 主线程通过 `thread.join()` 等待完成

**如果仍然出现该错误：**
1. 重启后端服务
2. 确保使用最新的代码
3. 清空所有浏览器会话后重试

---

### 错误 1：没有活跃的浏览器会话

**错误信息：**
```
没有活跃的浏览器会话，请先创建登录会话
```

**原因：**
- 浏览器会话已超时
- 浏览器被手动关闭
- 后端服务重启

**解决方案：**
1. 刷新页面
2. 重新点击"创建登录状态"
3. 等待浏览器打开后再保存

### 错误 2：浏览器会话还未就绪

**错误信息：**
```
浏览器会话还未就绪，请稍后重试
```

**原因：**
- 浏览器正在启动中
- 页面还未完全加载

**解决方案：**
1. 等待 5-10 秒
2. 确认浏览器已完全打开
3. 确认页面已加载完成
4. 再次点击"保存登录状态"

### 错误 3：项目不存在

**错误信息：**
```
项目不存在
```

**原因：**
- 项目已被删除
- 项目 ID 错误

**解决方案：**
1. 返回项目列表
2. 确认项目是否存在
3. 重新进入项目配置页面

### 错误 4：保存失败 - 文件权限问题

**错误信息：**
```
保存认证状态失败: [Errno 13] Permission denied
```

**原因：**
- `auth_states` 目录没有写入权限

**解决方案：**
```bash
# Windows
icacls c:\AI\testserver\backend\auth_states /grant Users:F

# Linux/Mac
chmod 755 backend/auth_states
```

### 错误 5：保存失败 - 浏览器上下文错误

**错误信息：**
```
保存失败: 'NoneType' object has no attribute 'storage_state'
```

**原因：**
- 浏览器上下文已被销毁
- 浏览器已关闭

**解决方案：**
1. 不要手动关闭浏览器
2. 重新创建登录会话
3. 确保登录完成后立即保存

## 调试步骤

### 步骤 1：检查后端日志

后端会输出详细的日志，查看终端或日志文件：

```
========== 开始保存认证状态 (Project ID: 1) ==========
✅ 项目存在: 测试项目
✅ 找到浏览器会话
   - Ready: True
   - Context: <BrowserContext>
   - Browser: <Browser>

💾 开始保存认证状态...
   - AuthStateManager 已初始化
   - 目标文件: backend/auth_states/project_1_auth.json
   - 目录已准备
   - 开始调用 context.storage_state()...
   - storage_state() 调用成功
   - 读取并验证文件...
   - 验证成功: 5 个 cookies, 2 个 origins
   - save_auth_state 返回: {'success': True, ...}

🔒 关闭浏览器...
   - 浏览器已关闭
   - Playwright 已停止
   - 会话已清理

✅ 保存成功!
========== 保存完成 ==========
```

### 步骤 2：检查浏览器会话状态

在浏览器控制台执行：

```javascript
// 打开浏览器控制台 (F12)
console.log('会话检查');

// 检查是否有 Cookies
document.cookie

// 检查 LocalStorage
localStorage

// 检查 SessionStorage
sessionStorage
```

### 步骤 3：检查文件系统

```bash
# 检查 auth_states 目录
ls -la backend/auth_states/

# 检查文件内容
cat backend/auth_states/project_1_auth.json | head -20

# 检查文件权限
ls -la backend/auth_states/project_1_auth.json
```

### 步骤 4：测试 Playwright

创建测试脚本 `test_playwright.py`：

```python
from playwright.sync_api import sync_playwright

def test_save_state():
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=False)
        context = browser.new_context()
        page = context.new_page()
        
        # 导航到测试页面
        page.goto('https://fanyi.baidu.com')
        
        # 等待用户登录
        input('登录完成后按 Enter...')
        
        # 保存状态
        try:
            context.storage_state(path='test_auth.json')
            print('✅ 保存成功!')
        except Exception as e:
            print(f'❌ 保存失败: {e}')
        
        browser.close()

if __name__ == '__main__':
    test_save_state()
```

运行测试：
```bash
python test_playwright.py
```

### 步骤 5：检查前端请求

打开浏览器开发者工具 (F12) → Network 标签页：

1. 点击"创建登录状态"
   - 检查请求：`POST /api/projects/1/auth-state/create`
   - 检查响应：应该返回 `{"success": true, ...}`

2. 点击"保存登录状态"
   - 检查请求：`POST /api/projects/1/auth-state/save`
   - 检查响应：应该返回 `{"success": true, ...}`
   - 如果返回 4xx/5xx，查看 `detail` 字段的错误信息

3. 检查轮询请求
   - 每 2 秒应该有：`GET /api/projects/1/auth-state/status`
   - 响应应该是：`{"has_session": true, "ready": true}`

## 完整测试流程

### 1. 准备工作

```bash
# 确保后端服务运行
cd c:\AI\testserver\backend
py main.py

# 确保前端服务运行
cd c:\AI\testserver\frontend
npm run dev
```

### 2. 测试步骤

1. **打开浏览器**
   - 访问 http://localhost:5173
   - 登录系统

2. **进入项目配置**
   - 点击项目名称
   - 点击"项目配置"标签页

3. **创建登录会话**
   - 点击"🔑 创建登录状态"
   - **观察后端日志**：应该看到"浏览器正在启动"
   - **观察前端**：应该显示"浏览器已打开"提示
   - **观察系统**：应该自动打开一个 Chromium 浏览器窗口

4. **完成登录**
   - 在自动打开的浏览器中登录
   - 确认登录成功（能看到用户信息）

5. **保存状态**
   - 回到网页
   - 点击"💾 保存登录状态"
   - **观察后端日志**：应该看到详细的保存过程
   - **观察前端**：应该显示成功消息
   - **观察浏览器**：应该自动关闭

6. **验证保存**
   - 检查文件：`backend/auth_states/project_1_auth.json`
   - 页面应该显示：Cookies 数量、文件大小等信息

## 常见问题排查

### 问题 1：点击"保存"后没有反应

**检查：**
1. 浏览器控制台是否有 JavaScript 错误
2. Network 标签页是否有请求发出
3. 请求是否返回错误

**解决：**
```bash
# 刷新页面
Ctrl + F5

# 清除浏览器缓存
Ctrl + Shift + Delete
```

### 问题 2：浏览器自动关闭了但保存失败

**检查：**
1. 后端日志中的错误信息
2. `auth_states` 目录是否存在
3. 文件权限是否正确

**解决：**
```bash
# 创建目录
mkdir backend/auth_states

# 设置权限 (Linux/Mac)
chmod 755 backend/auth_states
```

### 问题 3：保存后文件为空

**检查：**
```bash
# 查看文件大小
ls -lh backend/auth_states/project_1_auth.json

# 查看文件内容
cat backend/auth_states/project_1_auth.json
```

**可能原因：**
- 登录未成功
- 没有设置任何 Cookies
- 网站使用了特殊的认证方式

**解决：**
1. 确认登录确实成功
2. 检查浏览器是否有 Cookies（F12 → Application → Cookies）
3. 重新登录并保存

## 获取帮助

如果以上方法都无法解决问题，请提供：

1. **后端完整日志**
   - 从"开始保存认证状态"到"保存完成"的所有输出

2. **前端错误信息**
   - 浏览器控制台的错误信息
   - Network 标签页的请求/响应

3. **环境信息**
   ```bash
   # Python 版本
   python --version
   
   # Playwright 版本
   python -c "import playwright; print(playwright.__version__)"
   
   # 操作系统
   # Windows
   ver
   # Linux/Mac
   uname -a
   ```

4. **重现步骤**
   - 详细描述操作步骤
   - 在哪一步出错
   - 错误信息是什么
