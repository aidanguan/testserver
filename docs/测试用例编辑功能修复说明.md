# 测试用例编辑功能修复说明

## 修复的问题

### 1. Midscene 脚本为空的问题

**问题描述：**
- 编辑 ID 为 4 的 Midscene 测试用例时，midscene_script 字段显示为空
- 原因：在创建测试用例时，Midscene 脚本被存储在 `playwright_script` 字段中

**解决方案：**

1. **修改创建逻辑** (`TestCaseForm.vue`)
   - 根据 `executor_type` 将脚本保存到不同字段
   - Midscene 脚本 → `midscene_script` 字段
   - Playwright 脚本 → `playwright_script` 字段

2. **修改编辑逻辑** (`TestCaseEditDialog.vue`)
   - 添加兼容旧数据的逻辑
   - 如果是 Midscene 类型但 `midscene_script` 为空，自动从 `playwright_script` 读取

3. **数据迁移**
   - 创建 `migrate_midscene_scripts.py` 脚本
   - 将现有 Midscene 测试用例的脚本从 `playwright_script` 复制到 `midscene_script`

### 2. 添加"使用 LLM 重新生成脚本"功能

**功能描述：**
- 在编辑脚本界面（步骤 3）添加"使用 LLM 重新生成"按钮
- 点击后调用 LLM API 重新生成脚本
- 支持 Midscene 和 Playwright 两种脚本类型

**实现细节：**

1. **UI 组件**
   - 在编辑器头部添加按钮
   - 显示加载状态（regenerating）
   - 使用 MagicStick 图标

2. **API 调用**
   - Midscene: `testCaseAPI.generateMidsceneScript(caseId)`
   - Playwright: `testCaseAPI.generateScript(caseId)`

3. **脚本更新**
   - 自动格式化为 JSON（缩进 2 空格）
   - 更新到编辑器中

## 修改的文件

### 前端文件

1. **`frontend/src/views/TestCaseForm.vue`**
   - 修改 `saveTestCase` 方法
   - 根据 `executor_type` 区分保存脚本到不同字段

2. **`frontend/src/components/TestCaseEditDialog.vue`**
   - 修改 `initFormData` 方法，添加兼容旧数据的逻辑
   - 添加 `regenerateScript` 方法
   - 添加 `regenerating` 状态
   - 导入 `MagicStick` 图标
   - 更新编辑器头部布局

### 后端文件

无需修改（现有 API 已经支持）

### 数据库迁移

1. **`backend/add_midscene_script.py`**
   - 添加 `midscene_script` 字段到 `test_case` 表

2. **`backend/migrate_midscene_scripts.py`**
   - 将现有 Midscene 测试用例的脚本迁移到新字段

## 使用方法

### 编辑测试用例

1. 在项目详情页，点击测试用例的"编辑"按钮
2. 步骤 1：编辑描述信息
3. 步骤 2：编辑测试步骤
4. 步骤 3：编辑脚本
   - 如果是 Midscene 用例，会显示 Midscene 脚本
   - 如果是 Playwright 用例，会显示 Playwright 脚本

### 重新生成脚本

在步骤 3（编辑脚本）界面：

1. 点击右上角的"使用 LLM 重新生成"按钮
2. 系统会调用 LLM API 根据 `standard_steps` 重新生成脚本
3. 生成成功后，新脚本会自动填充到编辑器中
4. 检查脚本是否正确
5. 点击"保存"按钮保存修改

### 注意事项

1. **重新生成脚本会覆盖现有脚本**
   - 建议先复制保存原脚本
   - 或在重新生成后仔细检查

2. **脚本格式要求**
   - Midscene 脚本：必须是有效的 JSON 格式
   - Playwright 脚本：必须是有效的 JSON 格式

3. **兼容旧数据**
   - 系统会自动兼容旧数据
   - 如果 Midscene 用例的 `midscene_script` 为空，会从 `playwright_script` 读取

## 测试验证

### 测试用例 ID=4

**测试前：**
```
ID: 4
Name: 专业翻译功能访问测试
Executor Type: midscene
Midscene Script: None (实际存储在 playwright_script 中)
```

**测试后：**
```
ID: 4
Name: 专业翻译功能访问测试
Executor Type: midscene
Midscene Script: {"browser": "chromium", "viewport": ...}
```

### 功能测试

1. ✅ 编辑 Midscene 测试用例，脚本正常显示
2. ✅ 编辑 Playwright 测试用例，脚本正常显示
3. ✅ 点击"使用 LLM 重新生成"按钮，成功生成新脚本
4. ✅ 修改脚本并保存，成功更新
5. ✅ 兼容旧数据，自动从 `playwright_script` 读取

## 后续优化建议

1. **脚本编辑器增强**
   - 使用代码编辑器组件（如 Monaco Editor）
   - 提供语法高亮和自动补全
   - 提供 JSON 格式验证

2. **版本控制**
   - 保存脚本修改历史
   - 支持回滚到历史版本

3. **脚本对比**
   - 重新生成前显示对比界面
   - 高亮显示变化部分

4. **批量操作**
   - 支持批量重新生成脚本
   - 支持批量迁移旧数据
