# UI 界面保存登录状态指南

## 功能概述

通过项目配置页面的图形化界面，轻松管理 Playwright 的登录状态，无需使用命令行工具。

## 使用步骤

### 1. 进入项目配置

1. 在项目列表中，点击项目名称进入项目详情页
2. 点击"项目配置"标签页
3. 找到"🔐 登录状态管理"区域

### 2. 创建登录状态

#### 首次创建

如果还未保存登录状态，会显示：

![未配置状态](https://via.placeholder.com/600x200/E3F2FD/1976D2?text=未配置登录状态)

**操作步骤：**

1. **点击"🔑 创建登录状态"按钮**
   - 系统会自动使用项目的"测试站点 URL"打开浏览器
   - 如果未设置测试站点，会提示先配置

2. **在浏览器中登录**
   - 浏览器会自动打开（有头模式）
   - 导航到项目配置的测试站点
   - 手动完成登录操作
   - 输入用户名和密码
   - 点击登录按钮

3. **保存登录状态**
   - 登录成功后，页面会显示提示："请在浏览器中完成登录操作，然后点击下方的'保存登录状态'按钮"
   - 点击"💾 保存登录状态"按钮
   - 系统会自动保存浏览器的认证信息（Cookies、LocalStorage 等）
   - 浏览器自动关闭

4. **完成！**
   - 页面刷新，显示登录状态信息
   - 后续执行测试时会自动使用这个登录状态

### 3. 查看登录状态信息

保存成功后，会显示详细信息：

```
🔐 登录状态管理                    [✅ 已保存]

┌─────────────────┬───────────────────┐
│ Cookies 数量    │ 5                 │
│ 域名数量        │ 2                 │
│ 文件大小        │ 1.23 KB           │
│ 更新时间        │ 2024-01-15 14:30  │
└─────────────────┴───────────────────┘

[🔄 更新登录状态]  [🗑️ 删除登录状态]
```

### 4. 更新登录状态

如果登录状态过期或需要更新：

1. **点击"🔄 更新登录状态"按钮**
2. 浏览器会重新打开
3. 重新登录
4. 点击"💾 保存登录状态"
5. 完成更新

### 5. 删除登录状态

如果需要删除保存的登录状态：

1. **点击"🗑️ 删除登录状态"按钮**
2. 确认删除操作
3. 登录状态被清除
4. 下次执行测试需要重新登录

## 工作流程图

```
┌────────────────────────────────────────────────┐
│  1. 点击"创建登录状态"                          │
└────────────────┬───────────────────────────────┘
                 ▼
┌────────────────────────────────────────────────┐
│  2. 后端启动浏览器（有头模式）                  │
│     - 打开项目配置的测试站点 URL                │
└────────────────┬───────────────────────────────┘
                 ▼
┌────────────────────────────────────────────────┐
│  3. 用户在浏览器中手动登录                      │
│     - 输入用户名和密码                          │
│     - 点击登录按钮                              │
│     - 确认登录成功                              │
└────────────────┬───────────────────────────────┘
                 ▼
┌────────────────────────────────────────────────┐
│  4. 点击"保存登录状态"                          │
│     - 系统提取浏览器的认证信息                  │
│     - 保存到文件：auth_states/project_X_auth.json│
└────────────────┬───────────────────────────────┘
                 ▼
┌────────────────────────────────────────────────┐
│  5. 浏览器自动关闭，显示保存成功                │
└────────────────┬───────────────────────────────┘
                 ▼
┌────────────────────────────────────────────────┐
│  6. 后续执行测试时自动加载登录状态              │
└────────────────────────────────────────────────┘
```

## 界面说明

### 未配置状态

```
🔐 登录状态管理                    [ℹ️ 未配置]

┌───────────────────────────────────────────┐
│  ℹ️ 提示                                  │
│  保存登录状态后，测试用例执行时将自动加载  │
│  登录信息，无需每次都重新登录。            │
└───────────────────────────────────────────┘

[🔑 创建登录状态]
```

### 浏览器会话进行中

```
🔐 登录状态管理                    [ℹ️ 未配置]

[🔑 创建登录状态]

┌───────────────────────────────────────────┐
│  ✅ 浏览器已打开                           │
│  请在浏览器中完成登录操作，然后点击下方的  │
│  "保存登录状态"按钮。                      │
└───────────────────────────────────────────┘

[💾 保存登录状态]  [❌ 取消]
```

### 已保存状态

```
🔐 登录状态管理                    [✅ 已保存]

┌─────────────────┬───────────────────┐
│ Cookies 数量    │ 5                 │
│ 域名数量        │ 2                 │
│ 文件大小        │ 1.23 KB           │
│ 更新时间        │ 2024-01-15 14:30  │
└─────────────────┴───────────────────┘

[🔄 更新登录状态]  [🗑️ 删除登录状态]
```

## 使用场景

### 场景 1：百度翻译测试

1. **配置项目**
   - 项目名称：百度翻译测试
   - 测试站点：https://fanyi.baidu.com

2. **创建登录状态**
   - 点击"创建登录状态"
   - 浏览器打开百度翻译
   - 手动登录百度账号
   - 保存登录状态

3. **编写测试用例**
   ```json
   {
     "steps": [
       {"action": "goto", "value": "https://fanyi.baidu.com"},
       {"action": "click", "selector": "#pro-translation"}
     ]
   }
   ```

4. **执行测试**
   - 系统自动加载登录状态
   - 测试直接从登录后开始执行

### 场景 2：后台管理系统测试

1. **配置项目**
   - 项目名称：OA 系统测试
   - 测试站点：https://oa.company.com

2. **创建登录状态**
   - 点击"创建登录状态"
   - 登录管理员账号
   - 保存登录状态

3. **所有测试用例共享**
   - 项目下的所有测试用例
   - 都会自动使用这个登录状态
   - 无需每个用例都重复登录

## 常见问题

### Q: 如何知道登录状态是否过期？

A: 如果测试执行失败，提示"未登录"或"权限不足"，说明登录状态已过期，需要更新。

### Q: 可以为不同用户角色保存不同的登录状态吗？

A: 每个项目只能保存一个登录状态。如果需要测试不同用户角色，建议创建多个项目，每个项目对应一个用户角色。

### Q: 登录状态保存在哪里？

A: 保存在服务器端：`backend/auth_states/project_{项目ID}_auth.json`

### Q: 登录状态包含哪些信息？

A: 
- Cookies（会话令牌、用户ID等）
- LocalStorage（本地存储数据）
- SessionStorage（会话存储数据）
- IndexedDB（索引数据库）

### Q: 登录状态安全吗？

A: 
- ✅ 文件仅保存在服务器本地
- ✅ 不会提交到版本控制
- ✅ 只有项目成员可以访问
- ⚠️ 建议定期更新，避免长期使用

### Q: 如果浏览器无法打开怎么办？

A: 
1. 检查 Playwright 是否正确安装
2. 运行：`py -m playwright install chromium`
3. 检查防火墙设置

### Q: 可以取消正在进行的会话吗？

A: 可以。在浏览器会话进行中，点击"❌ 取消"按钮即可关闭浏览器并取消操作。

## 技术细节

### 后端实现

**API 端点：**
- `POST /api/projects/{project_id}/auth-state/create` - 创建浏览器会话
- `POST /api/projects/{project_id}/auth-state/save` - 保存认证状态
- `POST /api/projects/{project_id}/auth-state/cancel` - 取消会话
- `GET /api/projects/{project_id}/auth-state/status` - 获取会话状态
- `GET /api/projects/{project_id}/auth-state` - 获取认证状态信息
- `DELETE /api/projects/{project_id}/auth-state` - 删除认证状态

**工作流程：**
1. 前端调用 `create` API
2. 后端在后台线程启动 Playwright 浏览器
3. 前端轮询 `status` API 检查会话状态
4. 用户在浏览器中完成登录
5. 前端调用 `save` API
6. 后端保存 `context.storage_state()` 到文件
7. 后端关闭浏览器

### 前端实现

**关键功能：**
- 自动轮询会话状态（每2秒）
- 动态显示不同的 UI 状态
- 加载和显示认证状态信息
- 格式化时间戳显示

**状态管理：**
```javascript
const authStateInfo = ref({
  exists: false,
  cookies_count: 0,
  origins_count: 0,
  file_size: 0,
  modified_time: 0
})
const browserSessionActive = ref(false)
```

## 最佳实践

1. **及时保存**
   - 登录成功后立即保存
   - 避免浏览器会话长时间打开

2. **定期更新**
   - 建议每周更新一次登录状态
   - 避免使用过期的会话

3. **测试验证**
   - 保存后执行一个简单的测试用例
   - 验证登录状态是否有效

4. **安全管理**
   - 不要在公共场所操作
   - 及时删除不再使用的登录状态

## 与命令行工具对比

| 功能 | UI 界面 | 命令行工具 |
|------|---------|-----------|
| 易用性 | ⭐⭐⭐⭐⭐ 图形化操作 | ⭐⭐⭐ 需要输入命令 |
| 实时反馈 | ✅ 实时显示状态 | ⚠️ 需要手动检查 |
| 会话管理 | ✅ 自动管理 | ⚠️ 手动控制 |
| 状态查看 | ✅ 可视化显示 | ⚠️ 需要额外命令 |
| 适用场景 | 日常使用 | 自动化脚本 |

## 总结

UI 界面的登录状态管理功能提供了：
- ✅ 直观的图形化操作
- ✅ 实时的状态反馈
- ✅ 完整的功能支持
- ✅ 更好的用户体验

推荐日常使用 UI 界面进行登录状态管理，简单高效！
