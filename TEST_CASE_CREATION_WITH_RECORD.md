# 测试用例创建流程优化 - 支持录制生成脚本

## 功能概述

在测试用例创建的第三步（生成 Playwright 脚本），现在提供两种生成方式供用户选择：
1. **AI 自动生成** - 使用 LLM 根据标准化步骤自动生成
2. **手工录制** - 通过实际操作网站来录制脚本

## 完整创建流程

### 步骤 1：输入自然语言描述
- 用户使用自然语言描述测试场景
- 例如："访问登录页面，输入用户名 admin 和密码 admin，点击登录按钮，验证成功跳转到主页"

### 步骤 2：生成并编辑测试用例
- 系统使用 LLM 将自然语言转换为结构化的测试用例
- 包含：
  - 用例名称
  - 用例描述
  - 预期结果
  - 标准化测试步骤（表格形式展示）
- 用户可以编辑和调整

### 步骤 3：选择脚本生成方式 ✨ 新功能

#### 方式一：AI 自动生成
**适用场景：**
- 测试步骤相对标准
- 快速创建测试用例
- DOM 选择器相对简单

**操作流程：**
1. 点击"自动生成"卡片
2. 系统使用 LLM 根据步骤 2 的标准化步骤生成 Playwright 脚本
3. 生成后展示脚本详情供审核

**优点：**
- ⚡ 速度快
- 🤖 自动化程度高
- 📝 基于标准化步骤，逻辑清晰

**缺点：**
- 选择器可能不够准确
- 对于复杂的 UI 交互可能不准确

#### 方式二：手工录制 ✨ 新功能
**适用场景：**
- 复杂的 UI 交互
- 需要精确的 DOM 选择器
- 第一次创建某个场景的测试

**操作流程：**
1. 点击"手工录制"卡片
2. 在弹出的对话框中输入目标网址
3. 点击"开始录制"
   - 系统启动 Playwright Codegen
   - 打开浏览器窗口
4. 在浏览器中进行实际操作
   - 所有操作会被自动记录
   - Playwright 自动生成 Python 代码
5. 操作完成后点击"停止录制"
   - 系统使用 LLM 智能转换录制代码为 JSON 格式
   - 自动填充脚本数据
6. 审核生成的脚本

**优点：**
- ✅ 选择器准确（由实际 DOM 生成）
- 🎯 操作精确（实际操作的记录）
- 🔍 可视化（能看到实际效果）

**缺点：**
- 需要服务器有桌面环境（本地开发推荐）
- 略慢于自动生成

### 步骤 4：保存并完成
- 审核生成的脚本
- 可以选择"重新选择"切换生成方式
- 保存测试用例
- 可选择立即执行或返回项目

## 界面设计

### 选择生成方式界面
```
┌─────────────────────────────────────────────────┐
│             选择生成方式                          │
├─────────────────────────────────────────────────┤
│                                                  │
│  ┌──────────────┐        ┌──────────────┐      │
│  │   🪄         │        │   📹         │      │
│  │   自动生成    │        │   手工录制    │      │
│  │              │        │              │      │
│  │ 使用AI根据测  │        │ 通过实际操作  │      │
│  │ 试步骤自动生  │        │ 网站来录制脚  │      │
│  │ 成脚本        │        │ 本            │      │
│  │              │        │              │      │
│  │ [开始生成]   │        │ [开始录制]   │      │
│  └──────────────┘        └──────────────┘      │
│                                                  │
└─────────────────────────────────────────────────┘
```

### 录制对话框
```
┌────────────────────────────────────────┐
│  录制 Playwright 脚本              [X] │
├────────────────────────────────────────┤
│                                         │
│  目标网址: [https://____________]      │
│                                         │
│  ⚠️ 提示：                              │
│  • 录制会在服务器上打开浏览器窗口       │
│  • 如果是远程服务器，需要有桌面环境     │
│  • 建议在本地环境使用此功能             │
│                                         │
├────────────────────────────────────────┤
│              [取消]  [开始录制]         │
└────────────────────────────────────────┘
```

### 录制中界面
```
┌────────────────────────────────────────┐
│  录制 Playwright 脚本              [X] │
├────────────────────────────────────────┤
│                                         │
│         ✓ 正在录制                      │
│                                         │
│    请在弹出的浏览器窗口中进行操作       │
│                                         │
│          [停止录制]                     │
│                                         │
└────────────────────────────────────────┘
```

## 技术实现

### 前端代码结构

```javascript
// 状态管理
const scriptGenerated = ref(false)  // 是否已生成脚本
const showRecordDialog = ref(false) // 显示录制对话框
const recordingSessionId = ref(null) // 录制会话ID
const recordTargetUrl = ref('') // 录制目标URL

// 方法
const generateScriptByLLM = async () => {
  // 使用 LLM 自动生成脚本
}

const startRecording = async () => {
  // 启动录制会话
}

const stopRecording = async () => {
  // 停止录制并获取转换后的脚本
}

const resetScriptGeneration = () => {
  // 重新选择生成方式
}
```

### 数据流

#### AI 自动生成流程
```
用户点击"自动生成"
    ↓
调用 /api/cases/generate-script
    ↓
LLM 分析标准化步骤
    ↓
返回 JSON 格式的 Playwright 脚本
    ↓
展示给用户审核
```

#### 手工录制流程
```
用户点击"开始录制"
    ↓
调用 /api/record/start
    ↓
启动 Playwright Codegen（服务器端）
    ↓
用户在浏览器中操作
    ↓
用户点击"停止录制"
    ↓
调用 /api/record/{session_id}/stop
    ↓
读取录制的 Python 代码
    ↓
使用 LLM 转换为 JSON 格式
    ↓
返回并自动填充脚本
    ↓
展示给用户审核
```

### API 调用

#### 自动生成
```javascript
POST /api/cases/generate-script
Body: {
  "test_case_id": 123
}
Response: {
  "playwright_script": {
    "browser": "chromium",
    "viewport": { "width": 1280, "height": 720 },
    "steps": [...]
  }
}
```

#### 录制脚本
```javascript
// 开始录制
POST /api/record/start
Body: {
  "target_url": "https://example.com",
  "project_id": 1
}
Response: {
  "session_id": "uuid-xxx",
  "status": "recording",
  "message": "录制已启动"
}

// 停止录制
POST /api/record/{session_id}/stop
Response: {
  "status": "stopped",
  "playwright_code": "Python code...",
  "playwright_script": {
    "browser": "chromium",
    "viewport": { "width": 1280, "height": 720 },
    "steps": [...]
  }
}
```

## 用户体验优化

### 1. 清晰的视觉引导
- 使用卡片布局区分两种方式
- 图标清晰表达功能（🪄 自动生成，📹 手工录制）
- 不同颜色区分（蓝色 AI，绿色录制）

### 2. 灵活的选择
- 可以在两种方式之间切换
- "重新选择"按钮允许用户更换方式
- 不满意可以重新生成

### 3. 实时反馈
- Loading 状态显示
- 成功/失败消息提示
- 录制过程状态展示

### 4. 容错处理
- 录制失败自动回退
- LLM 转换失败使用规则转换
- 清晰的错误提示

## 使用建议

### 推荐使用 AI 自动生成的场景
1. 简单的表单填写和提交
2. 标准的导航和点击操作
3. 快速创建多个相似的测试用例
4. 测试步骤已经很清晰明确

### 推荐使用手工录制的场景
1. 复杂的拖拽操作
2. 多步骤的交互流程
3. 动态生成的元素
4. 需要精确的元素定位
5. 第一次测试某个新功能

### 组合使用策略
1. **先录制后调整**：录制基础脚本，然后手动优化选择器
2. **快速迭代**：AI 生成初版，录制关键步骤替换
3. **模板化**：录制一次，后续类似场景使用 AI 生成

## 优势总结

### 对测试人员
- ✅ 更灵活的脚本创建方式
- ✅ 更高的脚本准确性
- ✅ 更好的用户体验
- ✅ 学习曲线更平缓

### 对项目
- 🚀 提高测试用例创建效率
- 🎯 提升测试脚本质量
- 💡 降低维护成本
- 📊 适应更多测试场景

## 后续优化方向

1. **预览功能**：在保存前预览脚本执行效果
2. **模板库**：保存常用的录制脚本为模板
3. **智能推荐**：根据网站类型推荐生成方式
4. **批量操作**：支持录制多个场景组合
5. **协同编辑**：AI 生成 + 手工录制混合使用

## 总结

通过在测试用例创建流程的第三步提供两种脚本生成方式，系统变得更加灵活和强大：
- **AI 自动生成**提供速度和便利
- **手工录制**提供准确性和可靠性
- 用户可以根据实际需求选择最合适的方式
- 两种方式互为补充，共同提升测试效率

这个优化让测试用例创建变得更加智能、灵活和用户友好！🎉
