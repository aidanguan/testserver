# 部署指南

<cite>
**本文档引用的文件**  
- [start.ps1](file://backend/start.ps1)
- [start.ps1](file://frontend/start.ps1)
- [DEPLOYMENT.md](file://DEPLOYMENT.md)
- [main.py](file://backend/main.py)
- [config.py](file://backend/app/config.py)
- [vite.config.js](file://frontend/vite.config.js)
- [init_db.sql](file://backend/init_db.sql)
- [requirements.txt](file://backend/requirements.txt)
- [package.json](file://frontend/package.json)
</cite>

## 目录
1. [环境准备](#环境准备)
2. [数据库初始化](#数据库初始化)
3. [前后端服务启动](#前后端服务启动)
4. [反向代理配置](#反向代理配置)
5. [Docker化部署](#docker化部署)
6. [生产环境配置](#生产环境配置)
7. [日志与监控](#日志与监控)
8. [性能调优建议](#性能调优建议)
9. [高可用性部署规划](#高可用性部署规划)

## 环境准备

### 系统要求
本系统支持跨平台部署，适用于以下操作系统：
- Windows 10 及以上版本
- Linux（推荐 Ubuntu/Debian）
- macOS

所需软件环境：
- Python 3.9 或更高版本
- Node.js 16 或更高版本
- MySQL 8.0

### 依赖安装

#### Windows 环境
```powershell
# 检查 Python 版本
python --version

# 检查 Node.js 和 npm 版本
node --version
npm --version

# 安装 MySQL
# 建议从官方渠道下载并安装 MySQL 8.0
```

#### Linux 环境（Ubuntu/Debian）
```bash
# 更新包管理器并安装 Python
sudo apt update
sudo apt install python3.9 python3-pip python3-venv

# 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 安装 MySQL
sudo apt install mysql-server
sudo mysql_secure_installation
```

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L10-L45)

## 数据库初始化

### 创建数据库
系统使用 MySQL 作为持久化存储，需通过初始化脚本创建数据库和表结构。

```bash
# 执行数据库初始化脚本
mysql -u root -p < backend/init_db.sql
```

该脚本将创建名为 `ui_test_platform` 的数据库，并建立以下数据表：
- `user`：用户信息表
- `project`：项目信息表
- `test_case`：测试用例表
- `test_run`：测试运行记录表
- `step_execution`：步骤执行记录表
- `audit_log`：审计日志表

### 验证数据库
```sql
USE ui_test_platform;
SHOW TABLES;
```

### 默认管理员账户
系统初始化时会创建默认管理员账户：
- **用户名**：`admin`
- **密码**：`admin`

**重要提示**：首次登录后请立即修改默认密码。

**Section sources**
- [init_db.sql](file://backend/init_db.sql#L1-L116)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L50-L85)

## 前后端服务启动

### 使用 start.ps1 脚本启动

#### 后端服务启动
位于 `backend/start.ps1` 的脚本将自动完成以下操作：
1. 检查并创建 Python 虚拟环境
2. 激活虚拟环境
3. 安装 `requirements.txt` 中定义的依赖
4. 安装 Playwright 所需的 Chromium 浏览器
5. 启动 FastAPI 服务

```powershell
cd backend
.\start.ps1
```

服务启动后可通过 `http://localhost:8000/docs` 访问 API 文档。

#### 前端服务启动
位于 `frontend/start.ps1` 的脚本将：
1. 检查并安装 `node_modules`
2. 启动 Vite 开发服务器

```powershell
cd frontend
.\start.ps1
```

前端应用默认运行在 `http://localhost:5173`。

### 开发与生产模式
- **开发模式**：直接运行 `start.ps1` 脚本，支持热重载
- **生产模式**：建议使用 `uvicorn` 启动后端，前端使用 `npm run build` 构建静态资源

**Section sources**
- [backend/start.ps1](file://backend/start.ps1#L1-L26)
- [frontend/start.ps1](file://frontend/start.ps1#L1-L14)
- [main.py](file://backend/main.py#L1-L56)
- [vite.config.js](file://frontend/vite.config.js#L1-L21)

## 反向代理配置

### Nginx 配置示例
为实现前后端统一访问，建议使用 Nginx 作为反向代理服务器。

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 前端静态资源
    location / {
        root /path/to/frontend/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # 后端 API 代理
    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 前端代理配置
在开发环境中，`vite.config.js` 已配置本地代理，将 `/api` 请求转发至后端服务。

```javascript
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:8000',
      changeOrigin: true
    }
  }
}
```

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L180-L210)
- [vite.config.js](file://frontend/vite.config.js#L15-L21)

## Docker化部署

### 后端 Dockerfile
```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt
RUN playwright install chromium
RUN playwright install-deps

COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 前端 Dockerfile
```dockerfile
FROM node:18-alpine as build

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
```

### Docker Compose 配置
```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: ui_test_platform
    volumes:
      - mysql-data:/var/lib/mysql
      - ./backend/init_db.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
  
  backend:
    build: ./backend
    depends_on:
      - mysql
    environment:
      DB_HOST: mysql
      DB_USER: root
      DB_PASSWORD: rootpassword
    volumes:
      - ./artifacts:/app/artifacts
    ports:
      - "8000:8000"
  
  frontend:
    build: ./frontend
    depends_on:
      - backend
    ports:
      - "80:80"

volumes:
  mysql-data:
```

**容器部署要点**：
- **网络**：使用默认 bridge 网络，服务间通过服务名通信
- **卷挂载**：
  - 数据库数据持久化至 `mysql-data` 卷
  - 测试工件（截图、日志等）挂载至 `./artifacts`
- **环境变量**：通过 `environment` 字段注入数据库连接信息

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L215-L300)
- [requirements.txt](file://backend/requirements.txt#L1-L32)
- [package.json](file://frontend/package.json#L1-L23)

## 生产环境配置

### 数据库配置
- 使用专用数据库服务器，避免与应用服务共用资源
- 配置主从复制实现读写分离
- 定期备份策略（建议每日全量备份 + binlog 增量备份）

### HTTPS 配置
建议在 Nginx 层配置 SSL 证书，启用 HTTPS。

```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/privkey.pem;
    
    # 其他配置同HTTP
}
```

### 安全加固
1. 修改 `.env` 文件中的 `JWT_SECRET_KEY`
2. 配置防火墙规则，限制数据库端口访问
3. 启用数据库账户最小权限原则
4. 定期更新系统和应用依赖

**Section sources**
- [config.py](file://backend/app/config.py#L1-L41)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L320-L334)

## 日志与监控

### 日志管理
后端服务应配置日志轮转，避免日志文件过大。

```bash
# 查看实时日志
tail -f logs/app.log

# 使用 systemd 管理服务日志
sudo journalctl -u testplatform-backend -f
```

### 健康检查
系统提供健康检查接口：
- **端点**：`GET /health`
- **返回**：`{"status": "healthy"}`

建议配置定时健康检查，确保服务可用性。

### 监控方案
推荐使用以下监控组合：
- **Prometheus + Grafana**：系统指标监控
- **ELK Stack**：日志集中分析
- **New Relic / DataDog**：应用性能监控

**Section sources**
- [main.py](file://backend/main.py#L50-L55)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L285-L295)

## 性能调优建议

### 数据库优化
- 为常用查询字段创建索引（如 `test_case.project_id`、`test_run.status`）
- 定期分析慢查询日志，优化 SQL 语句
- 考虑使用 Redis 缓存高频访问数据

### 应用层优化
- 生产环境使用 `uvicorn` 多工作进程模式
- 配置连接池管理数据库连接
- 对静态资源启用 Gzip 压缩

### 前端优化
- 使用 CDN 加速静态资源加载
- 启用浏览器缓存策略
- 代码分割（Code Splitting）减少首屏加载时间

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L335-L349)

## 高可用性部署规划

### 水平扩展
- 部署多个后端实例，通过负载均衡器（如 Nginx、HAProxy）分发请求
- 使用 Redis 集中管理用户会话（Session）
- 前端静态资源可部署至多台服务器或使用 CDN

### 容灾备份
- 数据库主从架构，实现故障自动切换
- 工件存储使用分布式文件系统或对象存储（如 S3）
- 配置异地备份策略，确保数据安全

### 自动化运维
- 使用 CI/CD 流水线实现自动化部署
- 配置自动伸缩策略应对流量高峰
- 建立完善的告警机制，及时发现并处理异常

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L310-L334)