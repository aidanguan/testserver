# 测试策略

<cite>
**本文档引用的文件**
- [API_EXAMPLES.md](file://API_EXAMPLES.md)
- [E2E_TEST.md](file://E2E_TEST.md)
- [llm_service.py](file://backend/app/services/llm_service.py)
- [playwright_executor.py](file://backend/app/services/playwright_executor.py)
- [test_runs.py](file://backend/app/api/endpoints/test_runs.py)
- [main.py](file://backend/main.py)
- [TestCaseForm.vue](file://frontend/src/views/TestCaseForm.vue)
- [index.js](file://frontend/src/api/index.js)
</cite>

## 目录
1. [简介](#简介)
2. [测试类型](#测试类型)
3. [API端点测试](#api端点测试)
4. [前端组件测试](#前端组件测试)
5. [端到端测试](#端到端测试)
6. [API示例文档](#api示例文档)
7. [新增功能测试指南](#新增功能测试指南)
8. [测试覆盖率与CI集成](#测试覆盖率与ci集成)

## 简介
本测试策略文档旨在全面说明自然语言驱动UI测试平台的测试方法和实践。文档详细描述了项目采用的测试类型，包括API端点的单元测试与集成测试、前端组件的单元测试以及端到端测试。同时，文档解释了API示例如何用于测试和文档目的，描述了E2E测试的编写规范和执行流程，并为开发者提供了为新增功能编写测试用例的指导。

**Section sources**
- [README.md](file://README.md#L0-L306)

## 测试类型
本项目采用多层次的测试策略，确保代码质量和功能完整性。测试体系包括：

- **API端点测试**：使用FastAPI TestClient对后端API进行单元测试和集成测试
- **前端组件测试**：使用Vue Test Utils对Vue组件进行单元测试
- **端到端测试**：使用Playwright进行完整的用户场景测试
- **服务层测试**：对LLM服务和Playwright执行器进行单元测试

这些测试类型共同构成了一个完整的测试金字塔，从底层的单元测试到高层的端到端测试，确保系统的稳定性和可靠性。

**Section sources**
- [README.md](file://README.md#L0-L306)

## API端点测试
API端点测试使用FastAPI内置的TestClient进行，确保所有API接口按预期工作。

### 测试框架
后端API测试基于FastAPI TestClient，它允许在不启动实际服务器的情况下测试API端点。TestClient提供了与requests库类似的接口，可以轻松发送HTTP请求并验证响应。

### 测试范围
API测试覆盖所有主要端点，包括：
- 用户认证（登录、获取当前用户）
- 项目管理（创建、获取、更新项目）
- 测试用例管理（从自然语言生成用例、创建用例、生成脚本）
- 测试执行（执行测试用例、获取运行详情）

### 测试示例
```python
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

def test_login():
    response = client.post("/api/auth/login", json={
        "username": "admin",
        "password": "admin"
    })
    assert response.status_code == 200
    data = response.json()
    assert "access_token" in data
```

**Section sources**
- [main.py](file://backend/main.py#L0-L56)
- [test_runs.py](file://backend/app/api/endpoints/test_runs.py#L143-L181)

## 前端组件测试
前端组件测试使用Vue Test Utils和相关工具对Vue组件进行单元测试。

### 测试工具
- **Vue Test Utils**：官方的Vue组件测试工具
- **Jest**：JavaScript测试框架
- **Vue Test Utils匹配器**：提供Vue特定的断言

### 测试范围
前端测试主要覆盖以下组件：
- **TestCaseForm.vue**：测试用例创建表单组件
- **ProjectDetail.vue**：项目详情页面
- **LoginView.vue**：登录页面
- **UserManagement.vue**：用户管理组件

### 测试示例
```javascript
import { mount } from '@vue/test-utils'
import TestCaseForm from '@/views/TestCaseForm.vue'

describe('TestCaseForm.vue', () => {
  it('renders correctly', () => {
    const wrapper = mount(TestCaseForm)
    expect(wrapper.find('h3').text()).toBe('创建测试用例')
  })
})
```

**Section sources**
- [TestCaseForm.vue](file://frontend/src/views/TestCaseForm.vue#L0-L247)
- [package.json](file://frontend/package.json#L0-L22)

## 端到端测试
端到端测试使用Playwright进行，模拟真实用户操作，验证整个应用的工作流程。

### 测试框架
E2E测试基于Playwright，一个现代化的浏览器自动化工具，支持Chromium、Firefox和WebKit。

### 测试范围
E2E测试覆盖主要用户场景，包括：
- 用户认证流程（登录、登出、未授权访问保护）
- 项目管理（创建、查看、删除项目）
- 用户管理（创建、编辑、删除用户）
- 测试用例管理（使用自然语言创建测试用例）
- 测试执行（执行测试用例、查看执行结果）

### 测试编写规范
E2E测试应遵循以下规范：
1. **原子性**：每个测试用例应测试一个独立的功能点
2. **可重复性**：测试应在任何环境中都能重复执行
3. **独立性**：测试之间不应有依赖关系
4. **清晰性**：测试代码应易于理解和维护

### 执行流程
1. 准备测试环境（启动数据库、后端服务、前端服务）
2. 执行测试脚本
3. 记录测试结果
4. 清理测试环境

```python
import requests
import time

BASE_URL = "http://localhost:8000/api"

def test_login():
    """测试登录"""
    response = requests.post(f"{BASE_URL}/auth/login", json={
        "username": "admin",
        "password": "admin"
    })
    assert response.status_code == 200
    data = response.json()
    assert "access_token" in data
    assert "user" in data
    print("✓ 登录测试通过")
    return data["access_token"]
```

**Section sources**
- [E2E_TEST.md](file://E2E_TEST.md#L0-L273)
- [playwright_executor.py](file://backend/app/services/playwright_executor.py#L0-L213)

## API示例文档
API_EXAMPLES.md文件提供了平台API的实际使用示例，既作为文档也作为测试参考。

### 文档目的
API示例文档的主要目的包括：
- **开发者参考**：为开发者提供API使用的实际示例
- **测试基准**：作为测试的基准，确保API行为符合预期
- **文档验证**：验证API文档的准确性和完整性

### 示例内容
文档包含以下API的使用示例：
- 用户认证
- 项目管理
- 测试用例管理
- 测试执行
- 用户管理

### 使用方法
开发者可以使用这些示例来：
1. 理解API的使用方式
2. 验证API的实际行为
3. 作为编写测试用例的参考

```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin"
  }'
```

**Section sources**
- [API_EXAMPLES.md](file://API_EXAMPLES.md#L0-L483)
- [index.js](file://frontend/src/api/index.js#L52-L120)

## 新增功能测试指南
本节为开发者提供为新增功能编写测试用例的指导。

### 模拟LLM响应
由于LLM服务依赖外部API，测试时需要模拟其响应。可以使用unittest.mock或pytest-mock来模拟LLM服务的响应。

```python
from unittest.mock import Mock, patch
from app.services.llm_service import LLMService

@patch.object(LLMService, 'generate_test_case_from_nl')
def test_generate_test_case_from_nl(mock_generate):
    mock_generate.return_value = {
        "name": "测试用例",
        "description": "测试描述",
        "standard_steps": [],
        "expected_result": "预期结果"
    }
    
    # 测试代码
    result = llm_service.generate_test_case_from_nl("自然语言描述", "https://example.com")
    
    # 断言
    assert result["name"] == "测试用例"
    mock_generate.assert_called_once()
```

### 模拟Playwright行为
Playwright执行涉及浏览器操作，测试时需要模拟其行为。可以使用mock来模拟Playwright执行器的方法。

```python
@patch.object(PlaywrightExecutor, 'execute_script')
def test_execute_script(mock_execute):
    mock_execute.return_value = {
        "success": True,
        "steps": [],
        "error_message": None,
        "artifacts_path": "/path/to/artifacts"
    }
    
    # 测试代码
    result = executor.execute_script(script, run_id)
    
    # 断言
    assert result["success"] is True
    mock_execute.assert_called_once()
```

### 测试最佳实践
1. **测试覆盖率**：确保新增功能的测试覆盖率达到80%以上
2. **边界条件**：测试各种边界条件和异常情况
3. **性能测试**：对关键功能进行性能测试
4. **安全测试**：确保新增功能符合安全要求

**Section sources**
- [llm_service.py](file://backend/app/services/llm_service.py#L9-L325)
- [playwright_executor.py](file://backend/app/services/playwright_executor.py#L11-L213)

## 测试覆盖率与CI集成
本节描述测试覆盖率目标和持续集成（CI）的集成建议。

### 测试覆盖率目标
- **单元测试覆盖率**：核心业务逻辑的单元测试覆盖率应达到80%以上
- **集成测试覆盖率**：主要API端点的集成测试覆盖率应达到90%以上
- **E2E测试覆盖率**：关键用户场景的E2E测试覆盖率应达到100%

### CI集成建议
1. **自动化测试执行**：在CI流水线中自动执行所有测试
2. **测试覆盖率报告**：生成测试覆盖率报告并集成到CI中
3. **质量门禁**：设置质量门禁，测试失败或覆盖率不足时阻止合并
4. **并行测试执行**：将测试分组并行执行，缩短CI时间

### CI配置示例
```yaml
name: CI Pipeline

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        playwright install chromium
    - name: Run tests
      run: |
        python -m pytest tests/ --cov=app --cov-report=html
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v1
```

**Section sources**
- [requirements.txt](file://backend/requirements.txt)
- [start.ps1](file://backend/start.ps1)